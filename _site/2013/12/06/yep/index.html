<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Profiling C++ Extensions with Yep &middot; Camille Scott
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-lamprey">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Camille Scott
        </a>
      </h1>
      <p class="lead"><b>Bioinformatics PhD munging @ UC Davis.</b></p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">about</a>
          
        
      
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/posts/">posts</a>
          
        
      

      <a class="sidebar-nav-item" href="http://www.camillescott.org/dammit">dammit annotator</a>
      <a class="sidebar-nav-item" Href="https://twitter.com/camille_codon">@camille_codon</a>
      <a class="sidebar-nav-item" href="https://github.com/camillescott/camillescott.github.io">site source</a>

      
    </nav>

    <p>&copy; 2016. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Profiling C++ Extensions with Yep</h1>
  <span class="post-date">06 Dec 2013</span>
  <h3>Intro</h3>

<p>For those of you who work with both the python codebase and the <code>c++</code>
backend, I found a pretty useful tool. Seeing as we work with
performance-sensitive software, profiling is very useful; but, it can be
a pain to profile our <code>c++</code> code when called through python, which
necessitates writing <code>c++</code> wrappers to functions for basic profiling.
The solution I found is called
<a href="http://fa.bianp.net/blog/2011/a-profiler-for-python-extensions">yep</a>,
which is a python module made specifically to profile <code>c++</code> python
extensions. </p>

<h3>Installation</h3>

<p>In order to install, simply run:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">sudo apt-get install google-perftools</span>
<span class="go">sudo apt-get install python-dbg</span>
<span class="go">pip install yep</span></code></pre></figure>

<p>For khmer, you should also be sure to turn on debugging at compile time:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">cd /path/to/khmer</span>
<span class="go">make debug</span></code></pre></figure>

<p>The first is the python module implementing the profiler; the second is
the tool for analyzing the resulting profile information.</p>

<h3>Usage</h3>

<p>There are a couple ways to use it. You can call it directly from the
command line with:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">python -m yep [options] -- /path/to/script [args ... ]</span></code></pre></figure>

<p>The <code>--</code> is necessary, as it tells UNIX not to parse the resulting
arguments as flag arguments, which allows the profiler to pass them on
to the script being profiled instead of choking on them itself. Thanks
for this trick, @mr-c. Also make sure to use the absolute path to the
script to be profiled.</p>

<p>You can also use the module directly in your code, with:</p>

<figure class="highlight"><pre><code class="language-py" data-lang="py"><span class="kn">import</span> <span class="nn">yep</span>
<span class="n">yep</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s">&#39;outname&#39;</span><span class="p">)</span>
<span class="c"># &lt;code to profile...&gt;</span>
<span class="n">yep</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></code></pre></figure>

<p>The resulting file is then visualized using google-pprof, with:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">google-pprof --gif &lt;python executable&gt; &lt;profile&gt; &gt; prof.gif</span></code></pre></figure>

<p>In order to get python debugging symbols, you need to use the debugging
executable. So, while you may run the script in your virtualenv if using
one, you give google-pprof the debug executable so it can properly
construct callgraphs:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">python -m yep -- /w/khmer/scripts/sweep-reads-by-partition-buffered.py \</span>
<span class="go"> -k 25 -x 1e9 -o test_sweep -i /w/tests/test-sweep-contigs.fp \</span>
<span class="go">/w/tests/test-sweep-reads.fa</span>
<span class="go">google-pprof --gif /usr/bin/python2.7-dbg \</span>
<span class="go"> sweep-reads-by-partition-buffer.py.prof &gt; prof.gif</span></code></pre></figure>

<h3>Results</h3>

<p>Here is some example output:</p>

<p><img src="/public/prof.png" alt=""></p>

<p>In this call graph, the python debugging symbols were not properly
included; this is resolved by using the debugging executable.</p>

<p>The call graph is in standard form, where the first percentage is the
time in that particular function alone, and where the second percentage
is the time in all functions called by that function. See the
<a href="http://google-perftools.googlecode.com/svn/trunk/doc/cpuprofile.html">description</a>
for more details.</p>

<p>And that&#39;s it. Happy profiling!</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2014/05/05/context-management/">
            Context Managers and IPython Notebook
            <small>05 May 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2013/12/06/yep.md/">
            Profiling C++ Extensions with Yep
            <small>06 Dec 2013</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

  </body>
</html>
