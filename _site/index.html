<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Camille Scott &middot; Bioinformatician 905
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-lamprey">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Camille Scott
        </a>
      </h1>
      <p class="lead"><b>[Bioinformatician 905]</b></p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item active" href="/">home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">about</a>
          
        
      
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/posts/">posts</a>
          
        
      

      <a class="sidebar-nav-item" href="http://www.camillescott.org/dammit">dammit annotator</a>
      <a class="sidebar-nav-item" Href="https://twitter.com/camille_codon">@camille_codon</a>
      <a class="sidebar-nav-item" href="https://github.com/camillescott/camillescott.github.io">site source</a>

      
    </nav>

    <p>&copy; 2013-2016</p>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/01/20/pydoit-workshop/">
        pydoit half-day workshop debrief
      </a>
    </h1>

    <span class="post-date">20 Jan 2016</span>

    <h3>About</h3>

<p>Earlier today I taught a half-day workshop introducing students to 
<a href="http://pydoit.org/">doit</a> for automating their workflows and building applications.
This was an intermediate-level python workshop, in that it expected students to have
operational python knowledge. The <a href="http://www.camillescott.org/pydoit-intermediate/">materials</a>
are freely available, and the workshop was live-streamed on YouTube, where it is
<a href="https://www.youtube.com/watch?v=EfD9bWmL-1M">still available</a>.</p>

<p>This workshop was part of a series being put on by our lab the next few quarters. A
longer list of the workshops is at the <a href="http://dib-training.readthedocs.org/en/pub/">dib training site</a>, and Titus has <a href="http://ivory.idyll.org/blog/2015-training-for-q12-2016.html">written</a> on them <a href="http://ivory.idyll.org/blog/2015-3hr-remote-workshops.html">before</a>.</p>

<h3>Outcome</h3>

<p>Overall, I was happy with the results. Between the on-site participants and live-stream
viewers, our attendance was okay (about ten people total), and all students communicated
that they enjoyed the workshop and found it informative. Most of my materials (which I
mostly wrote from scratch) seemed to parse well, with the exception of a few minor bugs
which I caught during the lesson and was able to fix. As per usual, our training
coordinator <a href="https://twitter.com/jessicamizzi">Jessica</a> did a great job handling the
logistics, and we were able to use of the brand new Data Science Initiative space in
the Shields Library on the UC Davis campus.</p>

<h3>Thoughts for the Future</h3>

<p>We did have a number of no-shows, which was disappointing. My intuition is that this
was caused by a mixture of it being the beginning of the quarter here, with many
students, postdocs, staff, and faculty just returning, and the more advanced nature
of the material, which tends to scare folks away. It might be another piece of data
to support the idea of charging five bucks or so for tickets to require a small amount
of activation energy and thus filter out likely no-shows, but we&#39;ve had good luck so
far with attendance, and it&#39;d be best to make such a decision after we run a few more
similar workshops (perhaps it would only need to be done for the intermediate or 
advanced ones, for example).</p>

<p>We also had several students with installation issues, a recurring problem for these
sorts of events. I&#39;m leaning toward trying out browser-based approaches in the future,
which would allow me to set up configurations ahead of time (likely via docker files)
and short-circuit the usual cross-platform, python distribution, and software
installation issues.</p>

<p>I really enjoyed the experience, as this was the first workshop I&#39;ve run where
I created all the materials myself. I&#39;m looking forward to doing more in the future.</p>

<p>--camille</p>

<p>ps. this has been my first post in a long time, and I&#39;m hoping to keep them flowing.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2014/05/05/context-management/">
        Context Managers and IPython Notebook
      </a>
    </h1>

    <span class="post-date">05 May 2014</span>

    <p>Recently, I&#39;ve been making a lot of progress on the lamprey
transcriptome project, and that has involved a lot of IPython notebook.
While I&#39;ll talk about lamprey in a later post, I first want to talk
about a nice technical tidbit I came up with while trying to manage a
large IPython notebook with lots of figures. This involved learning some
more about the internals of matplotlib, as well as the usefulness of the
with statement in python.</p>

<p>So first, some background!
<a href="http://matplotlib.org/index.html">matplotlib</a> is the go-to plotting
package for python. It has many weaknesses, and a whole series of posts
could be (and has been) written about why we should use something else,
but for now, its reach is long and it is widely used in the scientific
community. It&#39;s particularly useful in concert with IPython notebook,
where figures can be embedded into cells inline. However, an important
feature(?) of matplotlib is that it&#39;s built around a state machine; when
it comes to deciding what figure (and other components) are currently
being worked with, matplotlib keeps track of the current context
globally. That allows you to just call <code>plot()</code> at any given time and
have your figures be pushed more or less where you&#39;d like. It <em>also</em>
means that you need to keep track of the current context, lest you end
up drawing a lot of figures onto the same plot and producing a terrible
abomination from beyond space and time itself.</p>

<p>IPython has a number of ways of dealing with this. While in its inline
mode, the default behavior is to simply create a new plotting context at
the beginning of each cell, and close it at the cell&#39;s completion. This
is convenient because it means the user doesn&#39;t have to open and close
figures manually, saving a lot of coding time and boilerplate. It
becomes a burden, however, when you have a large notebook, with lots of
figures, some of which you don&#39;t want to be automatically displayed.
While we can turn off the automatic opening and closing of figures with</p>

<figure class="highlight"><pre><code class="language-py" data-lang="py"><span class="o">%</span><span class="n">config</span> <span class="n">InlineBackend</span><span class="o">.</span><span class="n">close_figures</span> <span class="o">=</span> <span class="bp">False</span></code></pre></figure>

<p>we&#39;re now stuck with having to manage our own figure context. Suddenly,
our notebooks aren&#39;t nearly as clean and beautiful as they once were,
being littered with ugly declarations of new figures and axes, calls to
<code>gcf()</code> and <code>plt.show()</code>, and other such not-pretty things. I like
pretty things, so I sought out a solution. As it tends to do, python
delivered.</p>

<p>Enter context managers!</p>

<p>Some time ago, many&#39;s a programmer was running into a similar problem
with opening and closing files (well, and a lot of other use cases). To
do things properly, we needed to do exception handling to properly and
cleanly call <code>close()</code> on our file pointers when something went wrong.
To handle such instances, python introduced <a href="https://docs.python.org/2/reference/datamodel.html#context-managers">context managers and the
with
statement</a>.
From the docs:</p>

<blockquote>
<p>A context manager is an object that defines the runtime context to be
established when executing a with statement. The context manager
handles the entry into, and the exit from, the desired runtime context
for the execution of the block of code.</p>
</blockquote>

<p>Though this completely washes out the ~awesomeness~ of context
managers, it <em>does</em> sound about like what we want! In simple terms,
context managers are just objects that implement the <code>__enter__</code> and
<code>__exit__</code> methods. When you use the <code>with</code> statement on one of them,
<code>__enter__</code> is called, where we put our setup code ; if it returns
something, it takes the name given it by <code>as</code>. <code>__exit__</code> is called
after the <code>with</code> block is left, and contains the teardown code. For our
purposes, we want to take care of matplotlib context. Without further
ado, let&#39;s look at an example that does what we want:</p>

<figure class="highlight"><pre><code class="language-py" data-lang="py"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="k">class</span> <span class="nc">FigManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">exts</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;svg&#39;</span><span class="p">,</span> <span class="s">&#39;pdf&#39;</span><span class="p">,</span> <span class="s">&#39;png&#39;</span><span class="p">,</span> <span class="s">&#39;eps&#39;</span><span class="p">],</span> 
        <span class="n">show</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">fig_kwds</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">():</span>
            <span class="k">print</span> <span class="s">&#39;leaving context of&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> 
                     <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> 
                     <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
                     <span class="n">tight_layout</span><span class="o">=</span><span class="n">tight_layout</span><span class="p">,</span> 
                     <span class="o">**</span><span class="n">fig_kwds</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">exts</span> <span class="o">=</span> <span class="n">exts</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">show</span>

    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span> <span class="o">==</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span>

<span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_t</span><span class="p">,</span> <span class="n">exc_v</span><span class="p">,</span> <span class="n">trace_b</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">exc_t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&#39;ERROR&#39;</span><span class="p">,</span> <span class="n">exc_t</span><span class="p">,</span> <span class="n">exc_v</span><span class="p">,</span> <span class="n">trace_b</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&#39;saving figure&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exts</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{}.{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span> <span class="n">ext</span><span class="p">))</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show</span><span class="p">:</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span> <span class="o">==</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
    <span class="k">print</span> <span class="s">&#39;showing figure&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">)</span>

    <span class="k">print</span> <span class="s">&#39;closing figure&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">)</span>
    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span>
    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span>
    <span class="k">print</span> <span class="s">&#39;returning context to&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">())</span></code></pre></figure>

<p>Let&#39;s break this down. The <code>__init__</code> actually does most of our setup
here; it takes some basic parameters to pass to <code>plt.subplots</code>, as well
as some parameters for whether we want to show the plot and whether we
want to save the result to file(s). The <code>__enter__</code> method returns the
generated <code>figure</code> and <code>axes</code> objects. Finally, <code>__exit__</code> saves the
figure to the file name with the given extensions (matplotlib uses the
extension to infer the file format), and shows the plot if necessary. It
then calls <code>plt.close()</code> on the figure, deletes the <code>axes</code> objects from
the figure, and calls <code>del</code> on both instances just to be sure. The three
expected parameters to <code>__exit__</code> are for exception handling, which is
discussed in greater detail in the docs.</p>

<p>Here&#39;s an example of how I used it in practice:</p>

<figure class="highlight"><pre><code class="language-py" data-lang="py"><span class="k">with</span> <span class="n">FigManager</span><span class="p">(</span><span class="s">&#39;genes_per_sample&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">tall_size</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>

    <span class="n">genes_support_df</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;barh&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">labels_df</span><span class="o">.</span><span class="n">color</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;Represented Genes per Sample&#39;</span><span class="p">)</span>
<span class="n">FileLink</span><span class="p">(</span><span class="s">&#39;genes_per_sample.svg&#39;</span><span class="p">)</span></code></pre></figure>

<p>That&#39;s taken directly out of the lamprey
<a href="http://nbviewer.ipython.org/github/camillescott/2013-lamprey/blob/lamp3/pub/tale_of_two_transcriptomes_compute.ipynb">notebook</a>
where I first implemented this. I usually put a filelink in there, so
that the resulting image can easily be viewed in its own tab for closer
inspection.</p>

<p>The point is, all the normal boilerplate for handling figures is done in
one line and the code is much more clear and pretty! And of course, most
importantly, the original goal of not automatically displaying figures
is also taken care of.</p>

<p>I consider this yak shaved.</p>

<p>--camille</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2013/12/06/yep/">
        Profiling C++ Extensions with Yep
      </a>
    </h1>

    <span class="post-date">06 Dec 2013</span>

    <h3>Intro</h3>

<p>For those of you who work with both the python codebase and the <code>c++</code>
backend, I found a pretty useful tool. Seeing as we work with
performance-sensitive software, profiling is very useful; but, it can be
a pain to profile our <code>c++</code> code when called through python, which
necessitates writing <code>c++</code> wrappers to functions for basic profiling.
The solution I found is called
<a href="http://fa.bianp.net/blog/2011/a-profiler-for-python-extensions">yep</a>,
which is a python module made specifically to profile <code>c++</code> python
extensions. </p>

<h3>Installation</h3>

<p>In order to install, simply run:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">sudo apt-get install google-perftools</span>
<span class="go">sudo apt-get install python-dbg</span>
<span class="go">pip install yep</span></code></pre></figure>

<p>For khmer, you should also be sure to turn on debugging at compile time:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">cd /path/to/khmer</span>
<span class="go">make debug</span></code></pre></figure>

<p>The first is the python module implementing the profiler; the second is
the tool for analyzing the resulting profile information.</p>

<h3>Usage</h3>

<p>There are a couple ways to use it. You can call it directly from the
command line with:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">python -m yep [options] -- /path/to/script [args ... ]</span></code></pre></figure>

<p>The <code>--</code> is necessary, as it tells UNIX not to parse the resulting
arguments as flag arguments, which allows the profiler to pass them on
to the script being profiled instead of choking on them itself. Thanks
for this trick, @mr-c. Also make sure to use the absolute path to the
script to be profiled.</p>

<p>You can also use the module directly in your code, with:</p>

<figure class="highlight"><pre><code class="language-py" data-lang="py"><span class="kn">import</span> <span class="nn">yep</span>
<span class="n">yep</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s">&#39;outname&#39;</span><span class="p">)</span>
<span class="c"># &lt;code to profile...&gt;</span>
<span class="n">yep</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></code></pre></figure>

<p>The resulting file is then visualized using google-pprof, with:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">google-pprof --gif &lt;python executable&gt; &lt;profile&gt; &gt; prof.gif</span></code></pre></figure>

<p>In order to get python debugging symbols, you need to use the debugging
executable. So, while you may run the script in your virtualenv if using
one, you give google-pprof the debug executable so it can properly
construct callgraphs:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">python -m yep -- /w/khmer/scripts/sweep-reads-by-partition-buffered.py \</span>
<span class="go"> -k 25 -x 1e9 -o test_sweep -i /w/tests/test-sweep-contigs.fp \</span>
<span class="go">/w/tests/test-sweep-reads.fa</span>
<span class="go">google-pprof --gif /usr/bin/python2.7-dbg \</span>
<span class="go"> sweep-reads-by-partition-buffer.py.prof &gt; prof.gif</span></code></pre></figure>

<h3>Results</h3>

<p>Here is some example output:</p>

<p><img src="/public/prof.png" alt=""></p>

<p>In this call graph, the python debugging symbols were not properly
included; this is resolved by using the debugging executable.</p>

<p>The call graph is in standard form, where the first percentage is the
time in that particular function alone, and where the second percentage
is the time in all functions called by that function. See the
<a href="http://google-perftools.googlecode.com/svn/trunk/doc/cpuprofile.html">description</a>
for more details.</p>

<p>And that&#39;s it. Happy profiling!</p>

  </div>
  
</div>

<div class="pagination">
  
    <span class="pagination-item older">Older</span>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>
    </div>

  </body>
</html>
